{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-end mb-3">
  <div>
    <h2 class="mb-1">หน้ารายละเอียดข่าวลือ</h2>
    <div class="text-secondary">ดูรายละเอียด จำนวนรายงาน และสถานะปัจจุบัน</div>
  </div>
  <a class="btn btn-outline-light btn-sm" href="{{ url('rumourList') }}">
    <i class="bi bi-arrow-left me-1"></i>กลับไปหน้ารวม
  </a>
</div>

<div class="row g-3">
  <div class="col-lg-7">
    <div class="card shadow-soft h-100">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-start gap-2">
          <div>
            <div class="text-secondary small">รหัสข่าวลือ</div>
            <div class="text-mono fs-5">{{ rumour['rumourId'] }}</div>
          </div>
          <div class="text-end">
            {% if rumour['status'] == 'panic' %}
              <span class="badge text-bg-danger fs-6">PANIC</span>
            {% else %}
              <span class="badge text-bg-success fs-6">ปกติ</span>
            {% endif %}
          </div>
        </div>

        <h3 class="mt-3 mb-2">{{ rumour['title'] }}</h3>

        <div class="text-secondary mb-3">
          <i class="bi bi-megaphone me-1"></i>{{ rumour['source'] }} •
          <i class="bi bi-calendar3 me-1"></i>{{ rumour['createdAt'] }}
        </div>

        <div class="row g-2">
          <div class="col-md-4">
            <div class="statbox">
              <div class="text-secondary small">คะแนนความน่าเชื่อถือ</div>
              <div class="fs-4 fw-semibold">{{ "%.1f"|format(rumour['credibility']) }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="statbox">
              <div class="text-secondary small">จำนวนรายงาน</div>
              <div class="fs-4 fw-semibold">{{ rumour['reportCount'] }}</div>
              <div class="text-secondary small">PANIC เมื่อ &gt; {{ panicLimit }}</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="statbox">
              <div class="text-secondary small">ผลตรวจสอบ</div>
              {% if rumour['verdict'] == 'true' %}
                <div class="fs-4 fw-semibold">จริง</div>
              {% elif rumour['verdict'] == 'false' %}
                <div class="fs-4 fw-semibold">เท็จ</div>
              {% else %}
                <div class="fs-4 fw-semibold">ยังไม่ตรวจสอบ</div>
              {% endif %}
              {% if rumour['checkedAt'] %}
                <div class="text-secondary small">เมื่อ {{ rumour['checkedAt'] }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <hr class="border-secondary my-4">

        <h5 class="mb-2">รายงานข่าวลือนี้</h5>

        {% if canReport %}
          <form method="post" action="{{ url('rumourReport', rumourId=rumour['rumourId']) }}">
            <div class="row g-2">
              <div class="col-md-5">
                <label class="form-label">ประเภทรายงาน</label>
                <select class="form-select" name="reportType" required>
                  <option value="distortion">บิดเบือน</option>
                  <option value="incite">ปลุกปั่น</option>
                  <option value="fake">ข้อมูลเท็จ</option>
                </select>
              </div>
              <div class="col-md-7">
                <label class="form-label">หมายเหตุ (ไม่บังคับ)</label>
                <input class="form-control" name="note" placeholder="เช่น เห็นแชร์เยอะ ไม่มีแหล่งอ้างอิง">
              </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
              <button class="btn btn-primary">
                <i class="bi bi-flag-fill me-1"></i>ส่งรายงาน
              </button>
            </div>
          </form>
        {% else %}
          <div class="alert alert-warning alert-soft mb-0">
            {{ reasonText }}
          </div>
        {% endif %}

        {% if currentUser and currentUser['role'] == 'checker' and rumour['verdict'] == 'unknown' %}
          <hr class="border-secondary my-4">
          <h5 class="mb-2">สำหรับผู้ตรวจสอบ</h5>
          <form class="d-flex flex-wrap gap-2" method="post" action="{{ url('rumourVerify', rumourId=rumour['rumourId']) }}">
            <button class="btn btn-info" name="verdict" value="true">
              <i class="bi bi-check-circle me-1"></i>ยืนยันว่า “จริง”
            </button>
            <button class="btn btn-warning" name="verdict" value="false">
              <i class="bi bi-x-circle me-1"></i>ยืนยันว่า “เท็จ”
            </button>
          </form>
          <div class="text-secondary small mt-2">
            เมื่อตรวจสอบแล้ว ข่าวลือจะถูก “ล็อก” และไม่สามารถรายงานเพิ่มได้
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="card shadow-soft">
      <div class="card-body p-4">
        <h5 class="mb-3">ประวัติรายงาน (ล่าสุดก่อน)</h5>

        {% if reports|length == 0 %}
          <div class="text-secondary">ยังไม่มีรายงาน</div>
        {% else %}
          <div class="list-group list-group-dark">
            {% for p in reports %}
              <div class="list-group-item bg-dark border-secondary">
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold">{{ p['name'] }}</div>
                  <div class="text-secondary small">{{ p['reportedAt'] }}</div>
                </div>
                <div class="mt-1">
                  <span class="badge text-bg-secondary">
                    {{ 'บิดเบือน' if p['reportType'] == 'distortion' else ('ปลุกปั่น' if p['reportType'] == 'incite' else 'ข้อมูลเท็จ') }}
                  </span>
                  {% if p['note'] %}
                    <div class="text-secondary small mt-1">{{ p['note'] }}</div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
